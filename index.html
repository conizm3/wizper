<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wizper - Audio Hidden Object Game</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Lato:wght@300;400&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Lato', sans-serif;
            overscroll-behavior: none; /* バウンススクロール防止 */
        }
        h1, h2, .font-serif {
            font-family: 'Cinzel', serif;
        }
        /* ピンチズーム時のブラウザの挙動を抑制 */
        .game-container {
            touch-action: none;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS (SVG Components) ---
        const Play = ({ size = 24, className = "", fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const Pause = ({ size = 24, className = "", fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        );
        const HelpCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const ArrowLeft = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        );
        const Sparkles = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        );

        // --- GAME DATA ---
        const GAME_DATA = {
            appName: "Wizper", 
            chapter: "Chapter 1: The Master's Desk", 
            // ユーザー指定の画像URL
            imageUrl: "https://wordrobe.cc/wizper/images/chapter_1.png", 
            // 音声スクリプト
            script: "First, find the old key... yes, look down low. Then the strange stone, the mark, the sand, and finally the coin at the top.",
            targets: [
                { id: 1, name: "Old Key", x: 29.8, y: 84.6, radius: 7, found: false },
                { id: 2, name: "Stone", x: 74.3, y: 48.9, radius: 7, found: false },
                { id: 3, name: "Mark", x: 91.5, y: 38.3, radius: 7, found: false },
                { id: 4, name: "Sand", x: 22.6, y: 67.1, radius: 7, found: false },
                { id: 5, name: "Coin", x: 24.3, y: 11.7, radius: 7, found: false },
            ]
        };

        const App = () => {
            // --- STATE ---
            const [isPlaying, setIsPlaying] = useState(false);
            const [targets, setTargets] = useState(GAME_DATA.targets);
            const [zoom, setZoom] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [message, setMessage] = useState(null); 
            const [showHint, setShowHint] = useState(false);
            
            // DEV MODE STATE
            const [isDevMode, setIsDevMode] = useState(false);
            const [lastClickCoords, setLastClickCoords] = useState(null);

            // Refs
            const containerRef = useRef(null);
            const imageRef = useRef(null);
            const isDragging = useRef(false);
            const lastPosition = useRef({ x: 0, y: 0 });
            const lastTouchDistance = useRef(null);

            // --- AUDIO SIMULATION ---
            useEffect(() => {
                let timer;
                if (isPlaying) {
                    timer = setTimeout(() => setIsPlaying(false), 5000);
                }
                return () => clearTimeout(timer);
            }, [isPlaying]);

            // --- HANDLERS ---
            const handleMouseDown = (e) => {
                isDragging.current = true;
                lastPosition.current = { x: e.clientX, y: e.clientY };
            };

            const handleMouseMove = (e) => {
                if (!isDragging.current) return;
                const dx = e.clientX - lastPosition.current.x;
                const dy = e.clientY - lastPosition.current.y;
                setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                lastPosition.current = { x: e.clientX, y: e.clientY };
            };

            const handleMouseUp = () => {
                isDragging.current = false;
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const scaleAmount = -e.deltaY * 0.001;
                const newZoom = Math.min(Math.max(1, zoom + scaleAmount), 4);
                setZoom(newZoom);
            };

            const handleTouchStart = (e) => {
                if (e.touches.length === 1) {
                    isDragging.current = true;
                    lastPosition.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    lastTouchDistance.current = dist;
                }
            };

            const handleTouchMove = (e) => {
                // スマホでのドラッグ・ピンチ処理
                if (e.touches.length === 1 && isDragging.current) {
                    const dx = e.touches[0].clientX - lastPosition.current.x;
                    const dy = e.touches[0].clientY - lastPosition.current.y;
                    setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                    lastPosition.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2 && lastTouchDistance.current) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const delta = dist - lastTouchDistance.current;
                    const newZoom = Math.min(Math.max(1, zoom + delta * 0.01), 4);
                    setZoom(newZoom);
                    lastTouchDistance.current = dist;
                }
            };

            const handleTouchEnd = () => {
                isDragging.current = false;
                lastTouchDistance.current = null;
            };

            const handleImageClick = (e) => {
                if (!imageRef.current) return;

                const rect = imageRef.current.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const xPercent = parseFloat(((clickX / rect.width) * 100).toFixed(1));
                const yPercent = parseFloat(((clickY / rect.height) * 100).toFixed(1));

                if (isDevMode) {
                    setLastClickCoords({ x: xPercent, y: yPercent });
                    console.log(`Clicked at: x: ${xPercent}, y: ${yPercent}`);
                    return;
                }

                let hit = false;
                const newTargets = targets.map(target => {
                    if (target.found) return target;
                    const dist = Math.sqrt(
                        Math.pow(xPercent - target.x, 2) + 
                        Math.pow(yPercent - target.y, 2)
                    );
                    if (dist < target.radius) {
                        hit = true;
                        triggerFeedback(true, target.name);
                        return { ...target, found: true };
                    }
                    return target;
                });

                if (hit) {
                    setTargets(newTargets);
                } else {
                    triggerFeedback(false);
                }
            };

            const triggerFeedback = (isCorrect, name = "") => {
                if (isCorrect) {
                    setMessage({ type: 'success', text: `Found: ${name}` });
                } else {
                    setMessage({ type: 'error', text: "Not that one..." });
                }
                setTimeout(() => setMessage(null), 2000);
            };

            const remaining = targets.filter(t => !t.found).length;

            return (
                <div className="flex flex-col h-screen w-full bg-[#f9f9f7] text-[#2c2c2c] overflow-hidden select-none">
                    
                    {/* HEADER */}
                    <header className="flex justify-between items-center px-6 py-4 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-100 shadow-sm">
                        <div className="flex items-center gap-2 text-gray-400 w-20">
                            <ArrowLeft size={20} />
                            <span className="text-xs uppercase tracking-widest hidden sm:inline">Back</span>
                        </div>
                        
                        <div className="text-center flex flex-col items-center flex-1">
                            <span className="text-[10px] uppercase tracking-[0.2em] text-gray-400 mb-1">{GAME_DATA.appName}</span>
                            <h1 className="font-serif text-lg tracking-wide font-medium text-gray-800 truncate max-w-[200px]">{GAME_DATA.chapter}</h1>
                            <p className="text-[10px] text-gray-500 uppercase tracking-widest mt-1">
                                {remaining === 0 ? "Complete" : `${remaining} Items Left`}
                            </p>
                        </div>

                        <div className="w-20 flex justify-end">
                            <button 
                                onClick={() => setIsDevMode(!isDevMode)}
                                className={`text-[10px] font-bold px-2 py-1 border rounded transition-colors ${isDevMode ? 'bg-red-500 text-white border-red-500' : 'bg-gray-100 text-gray-400 border-gray-200'}`}
                            >
                                {isDevMode ? "DEV ON" : "DEV"}
                            </button>
                        </div>
                    </header>

                    {/* GAME VIEWPORT */}
                    <div 
                        ref={containerRef}
                        className="flex-1 relative overflow-hidden bg-[#e5e5e5] cursor-grab active:cursor-grabbing game-container"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onWheel={handleWheel}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        <div 
                            style={{
                                transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                                transformOrigin: '0 0',
                                transition: isDragging.current ? 'none' : 'transform 0.1s ease-out',
                                width: '100%',
                                height: '100%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            <div className="relative shadow-2xl" style={{ width: 'auto', height: '80vh' }}>
                                <img 
                                    ref={imageRef}
                                    src={GAME_DATA.imageUrl} 
                                    alt="Hidden Objects Scene" 
                                    className="max-h-full max-w-none object-contain pointer-events-auto"
                                    draggable={false}
                                    onClick={handleImageClick}
                                />
                                
                                {/* DEV MODE: TARGET MARKERS */}
                                {isDevMode && targets.map(t => (
                                   <div key={t.id} className="absolute border-2 border-blue-500 rounded-full bg-blue-500/20 pointer-events-none"
                                    style={{
                                      left: `${t.x}%`, top: `${t.y}%`,
                                      width: `${t.radius * 2}%`, height: `${t.radius * 2}%`,
                                      transform: 'translate(-50%, -50%)',
                                    }}
                                  >
                                    <span className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-[10px] px-1 rounded whitespace-nowrap z-50">
                                      {t.name}
                                    </span>
                                  </div>
                                ))}

                                {/* DEV MODE: CLICK MARKER */}
                                {isDevMode && lastClickCoords && (
                                   <div className="absolute w-4 h-4 bg-red-500 rounded-full pointer-events-none transform -translate-x-1/2 -translate-y-1/2 z-50 shadow-lg border-2 border-white"
                                    style={{ left: `${lastClickCoords.x}%`, top: `${lastClickCoords.y}%` }}
                                  />
                                )}
                            </div>
                        </div>

                        {/* DEV MODE: COORD DISPLAY */}
                        {isDevMode && lastClickCoords && (
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-50">
                                <div className="bg-red-500 text-white px-4 py-2 rounded shadow-lg font-mono text-xs">
                                    x: {lastClickCoords.x}, y: {lastClickCoords.y}
                                </div>
                            </div>
                        )}

                        {/* FEEDBACK OVERLAY */}
                        {!isDevMode && message && (
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20 w-full flex justify-center">
                                <div className={`px-6 py-3 shadow-xl flex items-center gap-3 transition-all animate-fade-in-up ${
                                    message.type === 'success' 
                                        ? 'bg-[#2c2c2c] text-white' 
                                        : 'bg-white text-[#2c2c2c] border border-gray-200'
                                }`}>
                                    {message.type === 'success' && <Sparkles size={16} className="text-yellow-400" />}
                                    <span className="font-serif italic text-sm tracking-wide">{message.text}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* FOOTER */}
                    <footer className="bg-white px-8 py-6 pb-8 border-t border-gray-100 flex justify-between items-center z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                        <button 
                            onClick={() => setIsPlaying(!isPlaying)}
                            className={`flex items-center gap-3 transition-colors ${isPlaying ? 'text-gray-400' : 'text-black'}`}
                        >
                            <div className={`w-12 h-12 rounded-full border border-gray-300 flex items-center justify-center transition-all ${isPlaying ? 'animate-pulse bg-gray-50' : 'hover:bg-gray-50'}`}>
                                {isPlaying ? <Pause size={20} className="opacity-50" /> : <Play size={20} />}
                            </div>
                            <div className="flex flex-col text-left">
                                <span className="text-[10px] uppercase tracking-widest text-gray-400">The Master</span>
                                <span className="font-serif text-sm italic">
                                    {isPlaying ? "Speaking..." : "Listen to order"}
                                </span>
                            </div>
                        </button>

                        <button 
                            onClick={() => setShowHint(!showHint)}
                            className="p-3 text-gray-400 hover:text-gray-800 transition-colors active:scale-95"
                        >
                            <HelpCircle size={22} strokeWidth={1.5} />
                        </button>
                    </footer>

                    {/* HINT OVERLAY */}
                    {showHint && (
                        <div className="absolute inset-x-0 bottom-24 p-4 z-20 flex justify-center animate-fade-in-up">
                            <div className="bg-white/90 backdrop-blur border border-gray-200 p-6 shadow-lg max-w-sm w-full text-center">
                                <h4 className="text-[10px] uppercase tracking-widest text-gray-400 mb-2">Transcript</h4>
                                <p className="font-serif text-sm italic leading-relaxed text-gray-700">
                                    "{GAME_DATA.script}"
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
