<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wizper - Audio Hidden Object Game</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Lato:wght@300;400&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Lato', sans-serif;
            overscroll-behavior: none;
            background-color: #f9f9f7;
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, .font-serif {
            font-family: 'Cinzel', serif;
        }
        .game-viewport {
            touch-action: none;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 横画面時にセーフエリアを確保 */
        .landscape-safe-right {
            padding-right: env(safe-area-inset-right);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        
        const Play = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="black" stroke="none" className={className}>
                <polygon points="7 4 21 12 7 20"/>
            </svg>
        );

        const Pause = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="black" stroke="none" className={className}>
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        );

        const ArrowLeft = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        );

        const Sparkles = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="white" stroke="none" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>
        );

        // Music Icons
        const MusicNote = ({ size = 22, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
        );

        const MusicOff = ({ size = 22, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="1" y1="1" x2="23" y2="23"/>
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
        );

        const GAME_DATA = {
            appName: "Wizper", 
            chapter: "The Master's Desk", 
            imageUrl: "https://wordrobe.cc/wizper/images/chapter_1.png", 
            script: "First, find the old key... yes, look down low. Then the strange stone, the mark, the sand, and finally the coin at the top.",
            targets: [
                { id: 1, name: "Old Key", x: 29.8, y: 84.6, radius: 7, found: false },
                { id: 2, name: "Stone", x: 74.3, y: 48.9, radius: 7, found: false },
                { id: 3, name: "Mark", x: 91.5, y: 38.3, radius: 7, found: false },
                { id: 4, name: "Sand", x: 22.6, y: 67.1, radius: 7, found: false },
                { id: 5, name: "Coin", x: 24.3, y: 11.7, radius: 7, found: false },
            ]
        };

        const App = () => {
            const [isPlaying, setIsPlaying] = useState(false); 
            const [isBgmPlaying, setIsBgmPlaying] = useState(false); 
            const [targets, setTargets] = useState(GAME_DATA.targets);
            const [zoom, setZoom] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [message, setMessage] = useState(null); 
            
            const [isDevMode, setIsDevMode] = useState(false);
            const [lastClickCoords, setLastClickCoords] = useState(null);

            const containerRef = useRef(null);
            const imageRef = useRef(null);
            const isDragging = useRef(false);
            const lastPosition = useRef({ x: 0, y: 0 });
            const lastPinchDistance = useRef(null);
            const lastTapTime = useRef(0);

            useEffect(() => {
                let timer;
                if (isPlaying) {
                    timer = setTimeout(() => setIsPlaying(false), 5000);
                }
                return () => clearTimeout(timer);
            }, [isPlaying]);

            const updateZoom = (newZoom, center) => {
                const clampedZoom = Math.min(Math.max(0.5, newZoom), 4);
                const zoomFactor = clampedZoom / zoom;
                const newPanX = center.x - (center.x - pan.x) * zoomFactor;
                const newPanY = center.y - (center.y - pan.y) * zoomFactor;
                setZoom(clampedZoom);
                setPan({ x: newPanX, y: newPanY });
            };

            const handleMouseDown = (e) => {
                isDragging.current = true;
                lastPosition.current = { x: e.clientX, y: e.clientY };
            };

            const handleMouseMove = (e) => {
                if (!isDragging.current) return;
                const dx = e.clientX - lastPosition.current.x;
                const dy = e.clientY - lastPosition.current.y;
                setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                lastPosition.current = { x: e.clientX, y: e.clientY };
            };

            const handleMouseUp = () => {
                isDragging.current = false;
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const rect = containerRef.current.getBoundingClientRect();
                const center = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                const delta = -e.deltaY * 0.001;
                updateZoom(zoom + delta, center);
            };

            const handleTouchStart = (e) => {
                if (e.touches.length === 1) {
                    isDragging.current = true;
                    lastPosition.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2) {
                    isDragging.current = false;
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    lastPinchDistance.current = dist;
                }
            };

            const handleTouchMove = (e) => {
                if (e.touches.length === 1 && isDragging.current) {
                    const dx = e.touches[0].clientX - lastPosition.current.x;
                    const dy = e.touches[0].clientY - lastPosition.current.y;
                    setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                    lastPosition.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2 && lastPinchDistance.current) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const rect = containerRef.current.getBoundingClientRect();
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                    const zoomChange = (dist - lastPinchDistance.current) * 0.005;
                    updateZoom(zoom + zoomChange, { x: centerX, y: centerY });
                    lastPinchDistance.current = dist;
                }
            };

            const handleTouchEnd = () => {
                isDragging.current = false;
                lastPinchDistance.current = null;
            };

            const handleImageClick = (e) => {
                if (!imageRef.current || isDragging.current || lastPinchDistance.current) return;

                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime.current;
                
                if (!isDevMode && (tapLength > 300 || tapLength < 50)) {
                    lastTapTime.current = currentTime;
                    return; 
                }
                
                lastTapTime.current = 0; 
                e.preventDefault();

                const rect = imageRef.current.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const xPercent = parseFloat(((clickX / rect.width) * 100).toFixed(1));
                const yPercent = parseFloat(((clickY / rect.height) * 100).toFixed(1));

                if (isDevMode) {
                    setLastClickCoords({ x: xPercent, y: yPercent });
                    return;
                }

                let hit = false;
                const newTargets = targets.map(target => {
                    if (target.found) return target;
                    const dist = Math.sqrt(
                        Math.pow(xPercent - target.x, 2) + 
                        Math.pow(yPercent - target.y, 2)
                    );
                    if (dist < target.radius) {
                        hit = true;
                        triggerFeedback(true, target.name);
                        return { ...target, found: true };
                    }
                    return target;
                });

                if (hit) {
                    setTargets(newTargets);
                } else {
                    triggerFeedback(false);
                }
            };

            const triggerFeedback = (isCorrect, name = "") => {
                if (isCorrect) {
                    setMessage({ type: 'success', text: `Found: ${name}` });
                } else {
                    setMessage({ type: 'error', text: "Not that one..." });
                }
                setTimeout(() => setMessage(null), 2000);
            };

            const remaining = targets.filter(t => !t.found).length;

            return (
                <div className="flex flex-col h-[100dvh] w-full bg-[#f9f9f7] text-[#2c2c2c] overflow-hidden select-none relative">
                    
                    {/* --- PORTRAIT HEADER (Visible only in portrait) --- */}
                    <header className="flex justify-between items-center px-6 py-4 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-100 shadow-sm shrink-0 landscape:hidden">
                        {/* LEFT: BACK */}
                        <div className="flex items-center gap-2 text-gray-400 w-20">
                            <ArrowLeft size={20} />
                            <span className="text-xs uppercase tracking-widest hidden sm:inline">Back</span>
                        </div>
                        
                        {/* CENTER: TITLE */}
                        <div className="text-center flex flex-col items-center flex-1">
                            <span className="text-[10px] uppercase tracking-[0.2em] text-gray-400 mb-1">{GAME_DATA.appName}</span>
                            <h1 className="font-serif text-lg tracking-wide font-medium text-gray-800 truncate max-w-[200px]">{GAME_DATA.chapter}</h1>
                            <p className="text-[10px] text-gray-500 uppercase tracking-widest mt-1">
                                {remaining === 0 ? "Complete" : `${remaining} Items Left`}
                            </p>
                        </div>

                        {/* RIGHT: BGM TOGGLE */}
                        <div className="w-20 flex justify-end">
                            <button 
                                onClick={() => setIsBgmPlaying(!isBgmPlaying)}
                                className="p-2 transition-colors active:scale-95 text-gray-800"
                            >
                                {isBgmPlaying ? (
                                    <MusicNote size={20} />
                                ) : (
                                    <MusicOff size={20} className="text-gray-300" />
                                )}
                            </button>
                        </div>
                    </header>

                    {/* --- LANDSCAPE HUD (Visible only in landscape) --- */}
                    <div className="hidden landscape:flex fixed right-4 top-1/2 -translate-y-1/2 flex-col gap-4 z-50 landscape-safe-right pointer-events-none">
                        <div className="bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-lg flex flex-col gap-6 items-center pointer-events-auto border border-white/50">
                            
                            {/* Play Button */}
                            <button 
                                onClick={() => setIsPlaying(!isPlaying)}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${isPlaying ? 'bg-gray-100 animate-pulse' : 'hover:bg-gray-50'}`}
                            >
                                {isPlaying ? <Pause size={18} /> : <Play size={18} />}
                            </button>

                            {/* BGM Button */}
                            <button 
                                onClick={() => setIsBgmPlaying(!isBgmPlaying)}
                                className="w-10 h-10 flex items-center justify-center opacity-80 hover:opacity-100"
                            >
                                {isBgmPlaying ? <MusicNote size={20} /> : <MusicOff size={20} className="text-gray-400" />}
                            </button>

                            {/* Items Left Counter */}
                            <div className="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center bg-white">
                                <span className="font-serif text-sm font-bold">{remaining}</span>
                            </div>

                        </div>
                    </div>


                    {/* VIEWPORT */}
                    <div 
                        ref={containerRef}
                        className="flex-1 relative overflow-hidden bg-[#e5e5e5] cursor-grab active:cursor-grabbing game-viewport"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onWheel={handleWheel}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        <div 
                            style={{
                                transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                                transformOrigin: '0 0',
                                width: '100%',
                                height: '100%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                willChange: 'transform'
                            }}
                        >
                            <div className="relative shadow-2xl" style={{ width: 'auto', height: '80vh' }}>
                                <img 
                                    ref={imageRef}
                                    src={GAME_DATA.imageUrl} 
                                    alt="Hidden Objects Scene" 
                                    className="max-h-full max-w-none object-contain pointer-events-auto"
                                    draggable={false}
                                    onClick={handleImageClick}
                                />
                                
                                {isDevMode && targets.map(t => (
                                   <div key={t.id} className="absolute border-2 border-blue-500 rounded-full bg-blue-500/20 pointer-events-none"
                                    style={{
                                      left: `${t.x}%`, top: `${t.y}%`,
                                      width: `${t.radius * 2}%`, height: `${t.radius * 2}%`,
                                      transform: 'translate(-50%, -50%)',
                                    }}
                                  >
                                    <span className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-[10px] px-1 rounded whitespace-nowrap z-50">
                                      {t.name}
                                    </span>
                                  </div>
                                ))}

                                {isDevMode && lastClickCoords && (
                                   <div className="absolute w-4 h-4 bg-red-500 rounded-full pointer-events-none transform -translate-x-1/2 -translate-y-1/2 z-50 shadow-lg border-2 border-white"
                                    style={{ left: `${lastClickCoords.x}%`, top: `${lastClickCoords.y}%` }}
                                  />
                                )}
                            </div>
                        </div>

                        {isDevMode && lastClickCoords && (
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-50">
                                <div className="bg-red-500 text-white px-4 py-2 rounded shadow-lg font-mono text-xs">
                                    x: {lastClickCoords.x}, y: {lastClickCoords.y}
                                </div>
                            </div>
                        )}

                        {!isDevMode && message && (
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20 w-full flex justify-center">
                                <div className={`px-6 py-3 shadow-xl flex items-center gap-3 transition-all animate-fade-in-up ${
                                    message.type === 'success' 
                                        ? 'bg-[#2c2c2c] text-white' 
                                        : 'bg-white text-[#2c2c2c] border border-gray-200'
                                }`}>
                                    {message.type === 'success' && <Sparkles size={16} fill="white" />}
                                    <span className="font-serif italic text-sm tracking-wide">{message.text}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- PORTRAIT FOOTER (Visible only in portrait) --- */}
                    <footer className="bg-white px-8 py-6 pb-safe border-t border-gray-100 flex justify-between items-center z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] shrink-0 landscape:hidden">
                        
                        {/* VOICE PLAY BUTTON */}
                        <button 
                            onClick={() => setIsPlaying(!isPlaying)}
                            className={`flex items-center gap-3 transition-colors ${isPlaying ? 'text-gray-400' : 'text-black'}`}
                        >
                            <div className={`w-12 h-12 rounded-full border border-gray-300 flex items-center justify-center transition-all ${isPlaying ? 'animate-pulse bg-gray-50' : 'hover:bg-gray-50'}`}>
                                {isPlaying ? <Pause size={16} /> : <Play size={16} />}
                            </div>
                            <div className="flex flex-col text-left">
                                <span className="text-[10px] uppercase tracking-widest text-gray-400">The Master</span>
                                <span className="font-serif text-sm italic">
                                    {isPlaying ? "Speaking..." : "Listen to order"}
                                </span>
                            </div>
                        </button>

                        {/* DEV MODE TOGGLE (Footer, Portrait Only) */}
                        <button 
                            onClick={() => setIsDevMode(!isDevMode)}
                            className={`text-[9px] font-bold px-2 py-1 rounded transition-colors ${isDevMode ? 'bg-red-500 text-white' : 'text-gray-300 hover:text-gray-400'}`}
                        >
                            {isDevMode ? "DEV ON" : "DEV"}
                        </button>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


